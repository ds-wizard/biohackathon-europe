<h2>Data Collection</h2>
<div class="question">
  <h3>What data will you collect or create?</h3>
  <p class="answer">
  
  {% set uuidDataSetsMeasured = "f5fef09d-ade5-4019-b089-f05bd89c34bc" %}
  {% set uuidNonEquipmentCapture = "f038bd46-ee4e-4f53-b7ea-482381c2c855" %}
  {% set uuidReferenceDataSets = "fcc51962-08df-4f4c-85ad-6bb932107010" %}
  {% set uuidNonReferenceDataSets = "be872000-cb98-442f-999c-ca3ef58dcfe8" %}

  {% call (reply) withReply(uuidDataSetsMeasured) %}
    {% set nDataSets = reply.value.value %}
    {% if nDataSets > 0 %}
      The following instrument datasets will be acquired in the project:
      <ul>
        {% set uuidDataSetName = "a077aec4-83d2-45c2-8d9f-75a391bdee20" %}
        {% set uuidDataSetCollectedBy = "ee59664e-4026-4796-a42a-e8003df6dadf" %}
        {% set uuidDataSetEquipment = "bce52f7f-2256-4afc-9801-2e4da8111470" %}

        {% for i in range(nDataSets - 1) %}
          <li>
            {% set pathPrefix = uuidDataSetsMeasured ~ "." ~ i ~ "." %}
            {% call (dataSetNameReply) withReply(pathPrefix ~ uuidDataSetName) %}
              <strong>{{ dataSetNameReply.value.value }}</strong>
            {% endcall %}

            {% call (dataSetCollectedByReply) withReply(pathPrefix ~ uuidDataSetCollectedBy) %}
              <br>
              This dataset will be collected by 
              {% set answerUuid = dataSetCollectedByReply.value.value %}
              {% set byExpertsOwn = "44ef09a4-5a78-439d-9fb4-940d3d84bfab" %}
              {% set byExpertsOut = "eb0b9a82-0379-47c3-967f-b35b40129af2" %}
              {% set byExternal = "f2784b7e-b0ed-4973-9d68-954c5c24e8bb" %}
              {% if answerUuid == byExpertsOwn %}
                experts in the project, with our own equipment.
              {% elif answerUuid == byExpertsOut %}
                experts in the project, at a specialized infrastructure.
              {% elif answerUuid == byExternal %}
                an external party.
                {% set pathPrefix = pathPrefix ~ uuidDataSetCollectedBy ~ "." ~ byExternal ~ "."  %}
                {% set uuidDataSetOwnership = "aa27852a-00f4-44a4-a85c-0e0fd3ac20d1" %}

                {% call (dataSetOwnershipReply) withReply(pathPrefix ~ uuidDataSetOwnership) %}
                  {% set answerUuid = dataSetOwnershipReply.value.value %}
                  {% set measuringParty = "786edd0d-ae07-489c-b078-423c18e02043" %}
                  {% set projectPartners = "306f7ef4-97fd-47b0-84de-f192cb94ea3a" %}
                  {% set otherArrangements = "399245d4-7988-461c-b940-ee813a1c99b1" %}
                  {% if answerUuid == measuringParty %}
                    The ownership of the resulting data will remain with the external party.
                  {% elif answerUuid == projectPartners %}
                    The project partners acquire full ownership of the data.
                  {% elif answerUuid == otherArrangements %}
                    {% set pathPrefix = pathPrefix ~ uuidDataSetOwnership ~ "." ~ otherArrangements ~ "." %}
                    {% set uuidDataSetOwnershipArrangements = "227f056a-ada1-473b-af71-bb63d48b4940" %}
                    {% call (dataSetOwnershipArrangementsReply) withReply(pathPrefix ~ uuidDataSetOwnershipArrangements) %}
                      For the ownership of the data we have made the following arrangements: {{ dataSetOwnershipArrangementsReply.value.value }}
                    {% endcall %}
                  {% endif %}
                {% endcall %}
              {% endif %}
            {% endcall %}

            {% call (dataSetEquipmentReply) withReply(pathPrefix ~ uuidDataSetEquipment) %}
              <br>It is  
              {% set answerUuid = dataSetEquipmentReply.value.value %}
              {% set isDescribed = "cba473be-2489-4387-8877-ce49cf95a304" %}
              {% set needCare = "526db9ec-a5a1-4431-9cc3-751fc6625217" %}
              {% if answerUuid == isDescribed %}
                very well described and known.
              {% elif answerUuid == needCare %}
                less well described or not completely standard, so we will need to take extra care documenting the process.
              {% endif %}
            {% endcall %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endcall %}

  {% call (reply) withReply(uuidNonEquipmentCapture) %}
    {% set captureTypes = [
        {
          "uuid": "85079340-7b80-4dc7-86ae-cc5f599ec737",
          "answerYes": "81baba8e-d43c-48f9-b39a-c0adfad08f64",
          "type": "questionnaires"
        },
        {
          "uuid": "36a5ed1e-ecd5-4b86-a719-f1196e376a52",
          "answerYes": "7fcce8f6-e52b-444e-88f6-74ba3e4ee37b",
          "type": "case report forms"
        },
        {
          "uuid": "7e456b72-72a1-427d-8e75-9da096bc9806",
          "answerYes": "2d3d08b8-7d63-4645-9499-f465caa06204",
          "type": "electronic patient records"
        }
      ]
    %}
    {% set replyUuids = replies|filter(
        (r) -> endswith(r.path, "85079340-7b80-4dc7-86ae-cc5f599ec737") || endswith(r.path, "36a5ed1e-ecd5-4b86-a719-f1196e376a52") || endswith(r.path, "7e456b72-72a1-427d-8e75-9da096bc9806")
      )|map(
        (r) -> r.value.value
      )
    %}
    {% set sources = captureTypes|filter((t) -> t.answerYes|in(replyUuids))|map((t) -> t.type) %}
    {% if sources|length == 0 %}
      We don't do any non-equipment data capture.
    {% else %}
      We also collect data from
      {% if sources|length == 1 %}
          {{ sources[0] }}.
      {% elif sources|length == 2 %}
          {{ sources[0] }} and {{ sources[1] }}.
      {% elif sources|length == 3 %}
          {{ sources[0] }}, {{ sources[1] }}, and {{ sources[2] }}.
      {% endif %}
    {% endif %}
    <br>
  {% endcall %}
  <br>{# :-( #}
  {% call (reply) withReply(uuidReferenceDataSets) %}
    {% set nDataSets = reply.value.value %}
    {% if nDataSets > 0 %}
      We will use the following reference datasets:
      <ul>
        {% set uuidDataSetName = "93988527-5bff-4125-8834-3750e9a28683" %}

        {% for i in range(nDataSets - 1) %}
          <li>
            {% set pathPrefix = uuidReferenceDataSets ~ "." ~ i ~ "." %}
            {% call (dataSetNameReply) withReply(pathPrefix ~ uuidDataSetName) %}
              <strong>{{ dataSetNameReply.value.value.value }}</strong>
            {% endcall %}
            {% set versioningPrefix = pathPrefix ~ "10b6548c-21cd-44c8-a8de-47415e7b012e.842007ce-0951-4655-8acc-b0f582e82ea1." %}
            {% set uuidVersion = "f00a28fb-ac77-4110-b285-c73c8bc62630" %}
            {% set uuidUpdate = "481d0157-6d89-4f68-9f3b-cf1b05f8f15d" %}
            {% call (versionReply) withReply(versioningPrefix ~ uuidVersion) %}
              <br>
              We will use version "{{ versionReply.value.value }}" of this dataset.
            {% endcall %}
            {% call (updateReply) withReply(versioningPrefix ~ uuidUpdate) %}
              <br>
              {% set answerUuid = updateReply.value.value %}
              {% set noUpdate = "a4f6a1da-536b-43fa-9637-71e33327fa08" %}
              {% set newUpdated = "069a0976-498c-4a47-b42f-33c6a1e40126" %}
              {% set allUpdated = "dc8dbe60-43e8-4ed4-ab11-13bb74aea820" %}
              If a new version becomes available during the project,
              {% if answerUuid == noUpdate %}
                we will stay with the old version.
              {% elif answerUuid == newUpdated %}
                new analyses will be done with the new version.
              {% elif answerUuid == allUpdated %}
                all analyses will be redone with the new version.
              {% endif %}
            {% endcall %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endcall %}
  {% call (reply) withReply(uuidNonReferenceDataSets) %}
    {% set nDataSets = reply.value.value %}
    {% if nDataSets > 0 %}
      We will use the following already existing non-reference datasets:
      <ul>
        {% set uuidDataSetName = "44120979-2840-4522-8297-df13f7fd1e3a" %}
        {% set uuidDataSetAccess = "62ddfc73-1680-4bbf-b198-6a7231875fb1" %}

        {% for i in range(nDataSets - 1) %}
          <li>
            {% set pathPrefix = uuidNonReferenceDataSets ~ "." ~ i ~ "." %}
            {% call (dataSetNameReply) withReply(pathPrefix ~ uuidDataSetName) %}
              <strong>{{ dataSetNameReply.value.value.value }}</strong>
            {% endcall %}
            {% call (dataSetAccessReply) withReply(pathPrefix ~ uuidDataSetAccess) %}
              <br>
              {% set answerUuid = updateReply.value.value %}
              {% set alreadyHaveCopy = "423f7c77-c3bd-4ece-a9f6-ad9e3d0428a1" %}
              {% set willDownload = "4e183e8d-d4bd-442a-a663-d3accf4f9217" %}
              {% set willOnline = "f5e1c4d3-79f7-4950-9b10-6a7738f21978" %}
              {% if answerUuid == noUpdate %}
                We already have a copy of this dataset.
              {% elif answerUuid == newUpdated %}
                We will download or get a copy.
              {% elif answerUuid == allUpdated %}
                We will use its online version without downloading it.
              {% endif %}
            {% endcall %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endcall %}

  {#
      -> be872000-cb98-442f-999c-ca3ef58dcfe8 (list) -> for each ->
      "We will use following already existing non-reference datasets: <ul>"
        for each <li>:
        -> 62ddfc73-1680-4bbf-b198-6a7231875fb1 (add sentence)
  #}
  </p>
</div>
